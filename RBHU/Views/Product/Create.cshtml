@model RBHU_DbServices.ViewModel.ProductViewModel
@{
    ViewData["Title"] = "Add New Product";
    Layout = "";
}

<link rel="icon" type="image/x-icon" href="~/images/as_logo.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<div class="create-product-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1"><i class="fas fa-plus-circle me-2"></i>Add New Product</h4>
                <p class="text-muted mb-0 small">Fill in the product details below</p>
            </div>
            <div class="d-flex gap-2">
                <a href="@Url.Action("Index", "Product")" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-list me-1"></i><span class="btn-text">Products</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container" style="display: none;">
        <div class="alert alert-dismissible fade show" role="alert" id="alertMessage">
            <span id="alertText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <!-- Main Form Card -->
    <div class="form-card">
        <div class="form-card-header">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Product Information</h5>
        </div>
        <div class="form-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="txtProductName" class="form-label">
                            Product Name <span class="required">*</span>
                        </label>
                        <input type="text" id="txtProductName" class="form-control" placeholder="Enter product name" />
                        <span class="error-message" id="nameError"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ddlCategory" class="form-label">
                            Category <span class="required">*</span>
                        </label>
                        <select id="ddlCategory" class="form-select">
                            <option value="">Select Category</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <span class="error-message" id="categoryError"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ddlSubCategory1" class="form-label">SubCategory 1</label>
                        <select id="ddlSubCategory1" class="form-select" disabled>
                            <option value="">Select SubCategory 1</option>
                        </select>
                        <small class="form-text">Select a category first</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ddlSubCategory2" class="form-label">SubCategory 2</label>
                        <select id="ddlSubCategory2" class="form-select" disabled>
                            <option value="">Select SubCategory 2</option>
                        </select>
                        <small class="form-text">Select subcategory 1 first</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="txtDescription" class="form-label">Description</label>
                <textarea id="txtDescription" class="form-control" rows="3" placeholder="Enter product description (optional)"></textarea>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="txtPrice" class="form-label">
                            Regular Price <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" step="0.01" id="txtPrice" class="form-control" placeholder="0.00" />
                        </div>
                        <span class="error-message" id="priceError"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="txtOfferPrice" class="form-label">Offer Price</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" step="0.01" id="txtOfferPrice" class="form-control" placeholder="0.00 (optional)" />
                        </div>
                        <span class="error-message" id="offerPriceError"></span>
                        <small class="form-text">Leave empty if no offer</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="imageFile" class="form-label">Product Image</label>
                <input type="file" id="imageFile" class="form-control" accept="image/*" />
                <span class="error-message" id="imageError"></span>
                <small class="form-text">Supported: JPG, PNG, GIF. Max: 5MB</small>
            </div>

            <div class="form-group" id="imagePreviewContainer" style="display: none;">
                <label class="form-label">Image Preview</label>
                <div class="image-preview-wrapper">
                    <img id="imagePreview" src="#" alt="Preview" class="image-preview" />
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeImage()">
                        <i class="fas fa-times me-1"></i>Remove Image
                    </button>
                </div>
            </div>
        </div>
        <div class="form-card-footer">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                    <i class="fas fa-undo me-1"></i>Reset
                </button>
                <button type="button" class="btn btn-success" onclick="saveProduct()" id="btnSave">
                    <i class="fas fa-save me-1"></i>Save Product
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let encodedImageData = null;

    // Theme Management
    function initTheme() {
        const savedTheme = localStorage.getItem('adminTheme') || 'light';
        applyTheme(savedTheme);
    }

    function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
    }

    $(document).ready(function () {
        initTheme();

        // Listen for theme changes from parent dashboard
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'THEME_CHANGE') {
                applyTheme(event.data.theme);
            }
        });

        $('#txtPrice, #txtOfferPrice').on('input', function () {
            validatePrices();
        });

        $('#imageFile').on('change', function () {
            handleImageUpload(this);
        });

        $('#ddlCategory').on('change', function () {
            var categoryId = $(this).val();
            if (categoryId) {
                loadSubCategories1(categoryId);
            } else {
                $('#ddlSubCategory1').html('<option value="">Select SubCategory 1</option>').prop('disabled', true);
                $('#ddlSubCategory2').html('<option value="">Select SubCategory 2</option>').prop('disabled', true);
            }
        });

        $('#ddlSubCategory1').on('change', function () {
            var subCategory1Id = $(this).val();
            if (subCategory1Id) {
                loadSubCategories2(subCategory1Id);
            } else {
                $('#ddlSubCategory2').html('<option value="">Select SubCategory 2</option>').prop('disabled', true);
            }
        });
    });

    function loadSubCategories1(categoryId) {
        $.ajax({
            url: '@Url.Action("GetSubCategories1", "Product")',
            type: 'GET',
            data: { categoryId: categoryId },
            success: function (response) {
                var options = '<option value="">Select SubCategory 1</option>';
                if (response.success && response.data && response.data.length > 0) {
                    response.data.forEach(function (item) {
                        options += '<option value="' + item.id + '">' + item.name + '</option>';
                    });
                    $('#ddlSubCategory1').html(options).prop('disabled', false);
                } else {
                    $('#ddlSubCategory1').html(options).prop('disabled', true);
                }
                $('#ddlSubCategory2').html('<option value="">Select SubCategory 2</option>').prop('disabled', true);
            }
        });
    }

    function loadSubCategories2(subCategory1Id) {
        $.ajax({
            url: '@Url.Action("GetSubCategories2", "Product")',
            type: 'GET',
            data: { subCategory1Id: subCategory1Id },
            success: function (response) {
                var options = '<option value="">Select SubCategory 2</option>';
                if (response.success && response.data && response.data.length > 0) {
                    response.data.forEach(function (item) {
                        options += '<option value="' + item.id + '">' + item.name + '</option>';
                    });
                    $('#ddlSubCategory2').html(options).prop('disabled', false);
                } else {
                    $('#ddlSubCategory2').html(options).prop('disabled', true);
                }
            }
        });
    }

    function handleImageUpload(element) {
        const file = element.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                showAlert('File size should not exceed 5MB', 'danger');
                element.value = '';
                $('#imagePreviewContainer').hide();
                encodedImageData = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function () {
                encodedImageData = reader.result;
                $('#imagePreview').attr('src', encodedImageData);
                $('#imagePreviewContainer').show();
            }
            reader.readAsDataURL(file);
        } else {
            $('#imagePreviewContainer').hide();
            encodedImageData = null;
        }
    }

    function removeImage() {
        $('#imageFile').val('');
        $('#imagePreviewContainer').hide();
        encodedImageData = null;
    }

    function saveProduct() {
        if (!validateForm()) {
            return;
        }

        const saveBtn = $('#btnSave');
        const originalText = saveBtn.html();
        saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Saving...');

        const productData = {
            Name: $('#txtProductName').val().trim(),
            Description: $('#txtDescription').val().trim(),
            Price: parseFloat($('#txtPrice').val()) || 0,
            OfferPrice: parseFloat($('#txtOfferPrice').val()) || null,
            CategoryId: parseInt($('#ddlCategory').val()),
            SubCategory1Id: parseInt($('#ddlSubCategory1').val()) || 0,
            SubCategory2Id: parseInt($('#ddlSubCategory2').val()) || 0,
            ImageData: encodedImageData
        };

        $.ajax({
            url: '@Url.Action("CreateProduct", "Product")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(productData),
            success: function (response) {
                saveBtn.prop('disabled', false).html(originalText);

                if (response.success) {
                    showAlert('Product saved successfully!', 'success');
                    setTimeout(function () {
                        window.location.href = '@Url.Action("Index", "Product")';
                    }, 1500);
                } else {
                    showAlert(response.message || 'Error occurred while saving the product.', 'danger');
                }
            },
            error: function (xhr, status, error) {
                saveBtn.prop('disabled', false).html(originalText);
                showAlert('An error occurred while saving the product.', 'danger');
            }
        });
    }

    function validateForm() {
        let isValid = true;
        clearErrors();

        if (!$('#txtProductName').val().trim()) {
            showFieldError('nameError', 'Product name is required');
            $('#txtProductName').addClass('is-invalid');
            isValid = false;
        }

        if (!$('#ddlCategory').val()) {
            showFieldError('categoryError', 'Please select a category');
            $('#ddlCategory').addClass('is-invalid');
            isValid = false;
        }

        const price = parseFloat($('#txtPrice').val());
        if (!price || price <= 0) {
            showFieldError('priceError', 'Please enter a valid price');
            $('#txtPrice').addClass('is-invalid');
            isValid = false;
        }

        if (!validatePrices()) {
            isValid = false;
        }

        return isValid;
    }

    function validatePrices() {
        const price = parseFloat($('#txtPrice').val()) || 0;
        const offerPrice = parseFloat($('#txtOfferPrice').val()) || 0;

        if (offerPrice > 0 && offerPrice >= price) {
            showFieldError('offerPriceError', 'Offer price must be less than regular price');
            $('#txtOfferPrice').addClass('is-invalid');
            return false;
        } else {
            $('#offerPriceError').text('');
            $('#txtOfferPrice').removeClass('is-invalid');
            return true;
        }
    }

    function showFieldError(fieldId, message) {
        $('#' + fieldId).text(message);
    }

    function clearErrors() {
        $('.error-message').text('');
        $('.form-control, .form-select').removeClass('is-invalid');
    }

    function showAlert(message, type) {
        $('#alertText').text(message);
        $('#alertMessage').removeClass('alert-success alert-danger alert-info alert-warning').addClass('alert-' + type);
        $('#alertContainer').show();

        setTimeout(function () {
            $('#alertContainer').fadeOut('slow');
        }, 5000);
    }

    function resetForm() {
        $('#txtProductName').val('');
        $('#txtDescription').val('');
        $('#txtPrice').val('');
        $('#txtOfferPrice').val('');
        $('#ddlCategory').val('');
        $('#ddlSubCategory1').html('<option value="">Select SubCategory 1</option>').prop('disabled', true);
        $('#ddlSubCategory2').html('<option value="">Select SubCategory 2</option>').prop('disabled', true);
        $('#imageFile').val('');
        $('#imagePreviewContainer').hide();
        encodedImageData = null;
        clearErrors();
    }
</script>

<style>
    :root {
        --bg-primary: #f5f7fa;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8fafc;
        --text-primary: #2d3748;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --border-color: #e2e8f0;
        --border-light: #f1f5f9;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --border-light: #475569;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .create-product-container {
        padding: 24px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .page-header {
        background: var(--bg-secondary);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
    }

    .page-header h4 {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.5rem;
    }

    .alert-container {
        margin-bottom: 20px;
    }

    .alert {
        border-radius: 8px;
        border: none;
        padding: 12px 16px;
        font-size: 0.9rem;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
    }

    .alert-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    [data-theme="dark"] .alert-success {
        background: #064e3b;
        color: #d1fae5;
    }

    [data-theme="dark"] .alert-danger {
        background: #7f1d1d;
        color: #fecaca;
    }

    [data-theme="dark"] .btn-close {
        filter: invert(1);
    }

    .form-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .form-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-card-header h5 {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .form-card-body {
        padding: 24px;
    }

    .form-card-footer {
        padding: 16px 24px;
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 12px 12px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: block;
    }

    .required {
        color: #ef4444;
    }

    .form-control,
    .form-select {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .form-control.is-invalid,
    .form-select.is-invalid {
        border-color: #ef4444;
    }

    .form-text {
        display: block;
        margin-top: 4px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .error-message {
        display: block;
        margin-top: 4px;
        font-size: 0.8rem;
        color: #ef4444;
    }

    .input-group-text {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-weight: 600;
        border-radius: 8px 0 0 8px;
    }

    .input-group .form-control {
        border-left: none;
        border-radius: 0 8px 8px 0;
    }

    .image-preview-wrapper {
        text-align: center;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .btn {
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        padding: 10px 20px;
        transition: var(--transition);
        border: none;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-outline-secondary {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .btn-outline-secondary:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-color: var(--text-muted);
    }

    .btn-outline-danger {
        background: var(--bg-secondary);
        color: #ef4444;
        border: 1px solid #ef4444;
    }

    .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .text-muted {
        color: var(--text-muted) !important;
    }

    /* Responsive - Matching Dashboard Style */
    @@media (max-width: 768px) {
        .create-product-container {
            padding: 16px 12px;
        }

        .page-header {
            padding: 16px;
        }

        .page-header h4 {
            font-size: 1.2rem;
        }

        .page-header h4 i {
            display: none;
        }

        .page-header p {
            font-size: 0.8rem;
        }

        .btn-text {
            display: none;
        }

        .btn-sm {
            padding: 6px 10px;
        }

        .form-card-body {
            padding: 16px;
        }

        .form-card-footer {
            padding: 12px 16px;
        }

        .form-label {
            font-size: 0.85rem;
        }

        .form-control,
        .form-select {
            font-size: 0.85rem;
            padding: 8px 12px;
        }
    }

    @@media (max-width: 576px) {
        .create-product-container {
            padding: 12px;
        }

        .page-header {
            padding: 12px;
        }

        .page-header h4 {
            font-size: 1.1rem;
        }

        .page-header p {
            display: none;
        }

        .form-card-header {
            padding: 16px;
        }

        .form-card-header h5 {
            font-size: 1rem;
        }

        .form-card-body {
            padding: 12px;
        }

        .form-card-footer {
            padding: 10px 12px;
        }

        .btn {
            font-size: 0.85rem;
            padding: 8px 14px;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        .image-preview {
            max-height: 150px;
        }
    }

    .fa-spin {
        animation: fa-spin 1s infinite linear;
    }

    @@keyframes fa-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
